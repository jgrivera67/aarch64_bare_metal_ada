/**
 *  Copyright (c) 2025, German Rivera
 *
 *
 *  SPDX-License-Identifier: Apache-2.0
 */

#include "utils_asm.h"

.section .text.reset_handler
.global reset_handler
reset_handler:
    /*
     * Use only CPU core 0:
     */
    mrs x0, mpidr_el1
    and x0, x0, #MPIDR_EL1_CPU_ID_MASK
    cmp x0, #0
    bne park_cpu

    /*
     * Initialize stack pointer:
     */
    adrp x0, _stack_end
    add x0, x0, #:lo12:_stack_end
    mov sp, x0

    /*
     * Call main() generated by gnat binder, which will do the elaboration
     * of Ada library-level packages and then invoke the main Ada subprogram
     */
    bl main

    b park_cpu

